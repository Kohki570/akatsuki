<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>あかつき</title>
</head>
<body>
    <input type="file" id="file-upload" multiple>
    <div id="file-list">読手</div>
    <div id ="s">0首目</div>
    
    <button id="play-button">ボタン</button>
    <audio id="audio-player" autoplay></audio>

    <script>
        let files;
        let lastPlayedFileNumber = null;
        var kaminokuisplaying = 0;
        var onmusic = 0;

        document.getElementById('file-upload').addEventListener('change', function(e) {
            files = e.target.files;
            playFileStartingWith('100');
            for (let i = 0; i < files.length; i++) {
                if (files[i].name.startsWith('100')) {
                    fileToPlay = files[i];

                    // ファイル名の最初の4文字と最後の4文字を除外して表示
                    const displayName = files[i].name.substring(4, files[i].name.length - 4);
                    document.getElementById('file-list').innerText = displayName;
                    break;
                }
            }
        });
//ここから
        document.getElementById('play-button').addEventListener('click', function() {
            if(lastPlayedFileNumber === '100'){
                playFileStartingWith('228');
                onmusic=1;
                
            }
            else if(kaminokuisplaying==0 && onmusic==1){
                document.getElementById('audio-player').pause();
                document.getElementById('audio-player').currentTime = 0;
                onmusic = 0;
                
            }
            else if (kaminokuisplaying == 0 && onmusic==0){
                document.getElementById('audio-player').play();
                onmusic=1;
            }
            else if (kaminokuisplaying == 1 && onmusic==1){
                document.getElementById('audio-player').pause();
                onmusic = 0;
            }
            else if(kaminokuisplaying == 1 && onmusic == 0 && s ===numElements){
                kaminokuisplaying=0;
                onmusic=1;
                let nextFileNumber = parseInt(lastPlayedFileNumber, 10) + 128;
                playFileStartingWith(nextFileNumber.toString().padStart(3, '0')); 
                f = (f+1);
            }
            else if (kaminokuisplaying == 1 && onmusic == 0) {
                kaminokuisplaying=0;
                onmusic=1;
                let nextFileNumber = parseInt(lastPlayedFileNumber, 10) + 128;
                playFileStartingWith(nextFileNumber.toString().padStart(3, '0'));  
            } 

        });
        function generateUniqueRandoms(numElements, rangeStart, rangeEnd) {
            let numbers = new Set();
        
            while(numbers.size < numElements) {
                let randomNumber = Math.floor(Math.random() * (rangeEnd - rangeStart + 1)) + rangeStart;
                numbers.add(randomNumber);
            }
        
            return Array.from(numbers);
        }
        
        let numElements = 100;  // 生成するランダム数の個数
        let rangeStart = 0;    // 範囲の開始点（含む）
        let rangeEnd = 99;    // 範囲の終了点（含む）
        
        let uniqueRandoms = generateUniqueRandoms(numElements, rangeStart, rangeEnd);
        
        
    var kaminoku = ["000", "001", "002","003", "004", "005", "006", "007", "008", "009", 
                    "010", "011", "012", "013", "014", "015", "016", "017", "018", "019", 
                    "020", "021", "022", "023", "024", "025", "026", "027", "028", "029", 
                    "030", "031", "032", "033", "034", "035", "036", "037", "038", "039", 
                    "040", "041", "042", "043", "044", "045", "046", "047", "048", "049", 
                    "050", "051", "052", "053", "054", "055", "056", "057", "058", "059", 
                    "060", "061", "062", "063", "064", "065", "066", "067", "068", "069", 
                    "070", "071", "072", "073", "074", "075", "076", "077", "078", "079", 
                    "080", "081", "082", "083", "084", "085", "086", "087", "088", "089", 
                    "090", "091", "092", "093", "094", "095", "096", "097", "098", "099"];

    var s = 0; // 呼んだ回数
    var f = 0; //終了カウント


        document.getElementById('audio-player').addEventListener('ended', function() {
            onmusic= 0;
               var kami= kaminoku[uniqueRandoms[s]];
            
                if (lastPlayedFileNumber === '228') {

                    setTimeout(function() {
                        playFileStartingWith(kami);
                    }, 1000);
                    s = (s + 1);
                    kaminokuisplaying = 1;
                    onmusic=1;
                
                }
                else if(f==1){
                    alert("すべての札が読み終わりました");
                }
                
                else if (kaminokuisplaying ==0) {

                    setTimeout(function() {
                        playFileStartingWith(kami);
                    }, 1000);
                    s = (s + 1);
                    kaminokuisplaying = 1;
                    onmusic=1;
                    
                    } 
                    document.getElementById('s').innerText = s +"首目";
             
        });

//ここまで

        function playFileStartingWith(prefix) {
            if (files) {
                for (let i = 0; i < files.length; i++) {
                    if (files[i].name.startsWith(prefix)) {
                        lastPlayedFileNumber = prefix;
                        const audioPlayer = document.getElementById('audio-player');
                        audioPlayer.src = URL.createObjectURL(files[i]);
                        audioPlayer.load();
                        audioPlayer.play();
                        break;
                    }
                }
            }
        }
    </script>
</body>
</html>
